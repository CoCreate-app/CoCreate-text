/* CoCreateJS */
"use strict";var CoCreateText={elements:[],init:function(){this.initElements(document),this.initSockets()},initElements:function(t){var e=this;let n=t||document,i=n.querySelectorAll("input[data-document_id][name], textarea[data-document_id][name]");0==i.length&&n!=document&&n.hasAttribute("data-document_id")&&n.hasAttribute("name")&&(i=[n]);for(var a=0;a<i.length;a++)CoCreateInput.isUsageY(i[a])&&(this.checkExistElement(i[a])||CoCreateUtils.getInitialized(i[a])||(CoCreateUtils.setInitialized(i[a]),this._initEvents(i[a]),CoCreateDocument.checkID(i[a])?this.createYDoc(i[a]):i[a].addEventListener("set-document_id",function(t){var n=this.value;e.createYDoc(this),e.sendChangeData(this,n,0,n.length)})))},initSockets:function(){let t=this;CoCreateSocket.listen("getDocument",function(e){e.metadata&&"crdt"==e.metadata.type&&t.elements.forEach(t=>{if(1==t.crudSetted)return;const n=t.getAttribute("data-collection"),i=t.getAttribute("data-document_id"),a=t.getAttribute("name");"false"!==t.getAttribute("data-fetch_value")&&CoCreateUtils.isReadValue(t)&&e.collection==n&&e.document_id==i&&a in e.data&&(CoCreate.replaceDataCrdt({collection:n,document_id:i,name:a,value:e.data[a]}),t.crudSetted=!0)})})},checkExistElement(t){for(var e=0;e<this.elements.length;e++)if(this.elements[e].isSameNode(t))return!0;return!1},setInitValue(t){var e=this.generateTypeName(t),n=CoCreateCrdt.getWholeString(e);t.value=n},createYDoc(t){const e=t.getAttribute("data-collection"),n=t.getAttribute("data-document_id");CoCreate.initDataCrdt({collection:e,document_id:n,name:t.getAttribute("name"),element:t});CoCreate.getDocument({collection:e,document_id:n,metadata:{type:"crdt"}}),this.elements.push(t)},_initEvents:function(t){var e=this;t.addEventListener("select",function(){this.selectionEnd!==this.selectionStart&&(e.setSelectionInfo(this,!0,this.selectionStart,this.selectionEnd),document.activeElement===this&&e.sendPosition(this))}),t.addEventListener("keyup",function(t){-1!=[37,38,39,40].indexOf(t.keyCode)&&e.sendPosition(this)}),t.addEventListener("keydown",function(t){-1!=[37,38,39,40].indexOf(t.keyCode)&&e.sendPosition(this)}),t.addEventListener("click",function(t){document.activeElement===this&&e.sendPosition(this)}),t.addEventListener("blur",function(t){const n=e.generateTypeName(this);CoCreateCrdt.setCursorNull(n)}),t.addEventListener("input",function(t){let n=this.selectionStart-1,i=n,a=e.getSelectionInfo(this),s="",o=!1;switch(t.inputType){case"deleteContentBackward":case"deleteContentForward":o=!0,i=++n+1;break;case"insertLineBreak":o=!0,s="\n",i++;break;case"insertText":o=!0,s=t.data||"\n";break;case"deleteByCut":o=!0}if(o)if(a.is_selected){let t=a.start-a.end;recalculate_local_cursors(this,t),e.sendChangeData(this,"",a.start,a.end),s.length>0&&e.sendChangeData(this,s,n,i),e.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}else e.sendChangeData(this,s,n,i)}),t.addEventListener("blur",function(t){e.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}),t.addEventListener("click",function(t){e.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}),t.addEventListener("paste",function(t){let n=t.clipboardData.getData("Text"),i=this.selectionStart,a=this.selectionEnd;i!=a&&(this.setSelectionRange(a,a),e.sendChangeData(this,"",i,a,!1)),e.sendChangeData(this,n,i,i,!1),t.preventDefault()}),t.addEventListener("cocreate-y-update",function(n){var i=n.detail;t.crudSetted=!0;var a=0,s=!0;i.forEach(t=>{t.retain&&(s=!0,a=t.retain),(t.insert||t.delete)&&(0==s&&(a=0),s=!1,t.insert?e.updateChangeData(this,t.insert,a,a):t.delete&&e.updateChangeData(this,"",a,a+t.delete))})})},setSelectionInfo:function(t,e,n,i){t.setAttribute("is_selected",e),t.setAttribute("selection_start",n),t.setAttribute("selection_end",i),this.sendPosition(t)},getSelectionInfo:function(t){return{is_selected:"true"===t.getAttribute("is_selected"),start:parseInt(t.getAttribute("selection_start")),end:parseInt(t.getAttribute("selection_end"))}},checkDocumentID:function(t){let e=t.getAttribute("data-document_id");return!(!e||""===e)},sendChangeData:function(t,e,n,i,a=!0){if(!this.checkDocumentID(t))return CoCreateDocument.requestDocumentId(t),void t.setAttribute("data-document_id","pending");if("pending"==t.getAttribute("data-document_id"))return;const s=t.getAttribute("data-collection"),o=t.getAttribute("data-document_id"),r=t.getAttribute("name");"false"!=t.getAttribute("data-save_value")&&(e.length>0?(a&&t.setRangeText("",n,n+e.length,"start"),CoCreate.insertDataCrdt({collection:s,document_id:o,name:r,value:e,position:n})):(a&&t.setRangeText(" ".repeat(i-n),n,n,"end"),CoCreate.deleteDataCrdt({collection:s,document_id:o,name:r,position:n,length:i-n})),document.activeElement===t&&this.sendPosition(t))},updateChangeData:function(t,e,n,i){let a=t.selectionStart,s=t.selectionEnd;t.setRangeText(e,n,i,"end"),a>=n&&(""==e?(s-=i-n,a=(a-=i-n)<n?n:a):(a+=e.length,s+=e.length)),""==e&&s>=n&&(s=s>=i?s-(i-n):n),t.selectionStart=a,t.selectionEnd=s;document.activeElement;refresh_mirror(t),updateFloatLabel(t,t.value)},generateTypeName(t){var e=t.getAttribute("data-collection"),n=t.getAttribute("data-document_id"),i=t.getAttribute("name");return CoCreateYSocket.generateID(config.organization_Id,e,n,i)},setText:function(t,e){var n=0,i=!0;e.forEach(e=>{e.retain&&(i=!0,n=e.retain),(e.insert||e.delete)&&(0==i&&(n=0),i=!1,e.insert?this.receiveChangeData(t,e.insert,n,n):e.delete&&this.receiveChangeData(t,"",n,n+e.delete))})},isAvaiableEl:function(t){for(var e=0;e<this.elements.length;e++)if(this.elements[e].isEqualNode(t))return!0;return!1},sendPosition:function(t){if(!this.isAvaiableEl(t))return;const e=this.generateTypeName(t);console.log(t.selectionStart,t.selectionEnd);let n=t.selectionStart,i=t.selectionEnd;CoCreateCrdt.setPositionYJS(e,n,i)}};CoCreateText.init(),CoCreateInit.register("CoCreateText",CoCreateText,CoCreateText.initElements);