!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.text=t():(e.CoCreate=e.CoCreate||{},e.CoCreate.text=t())}(this,function(){return i={},a.m=n=[function(e,t,n){"use strict";n.r(t);var i={elements:[],init:function(){this.initElement(document)},refreshElement:function(e){var t=e.target;t&&(e=t.tagName.toLowerCase(),["input","textarea"].includes(e)&&t.getAttribute("data-document_id")&&t.getAttribute("name")&&CoCreate.input.isUsageY(t)&&(CoCreate.observer.getInitialized(t,"text")||this.__initEvents(t),CoCreate.observer.setInitialized(t,"text"),CoCreate.document_id.checkID(t)&&this.createYDoc(t,!0)))},initElement:function(e){var i=this,t=e||document,e=t.querySelectorAll("input[data-document_id][name], textarea[data-document_id][name]");(e=0==e.length&&t!=document&&t.hasAttribute("data-document_id")&&t.hasAttribute("name")?[t]:e).forEach(function(e){CoCreate.input.isUsageY(e)&&(i.checkExistElement(e)||CoCreate.observer.getInitialized(e,"text")||(CoCreate.observer.setInitialized(e,"text"),i.__initEvents(e),CoCreate.document_id.checkID(e)?i.createYDoc(e):e.addEventListener("set-document_id",function(e){var t=this,n=t.value;i.createYDoc(t),i.sendChangeData(t,n,0,n.length)})))})},checkExistElement:function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].isSameNode(e))return!0;return!1},setInitValue:function(e){var t=this.generateTypeName(e),t=CoCreate.crdt.getWholeString(t);e.value=t},createYDoc:function(e,t){var n=e.getAttribute("data-collection"),i=e.getAttribute("data-document_id"),a=e.getAttribute("name");CoCreate.crdt.init({collection:n,document_id:i,name:a,element:e});t?e.value=CoCreate.crdt.getText({collection:n,document_id:i,name:a}):this.elements.push(e)},__initEvents:function(a){var o=this;a.addEventListener("select",function(){this.selectionEnd!==this.selectionStart&&(o.setSelectionInfo(this,!0,this.selectionStart,this.selectionEnd),document.activeElement===this&&o.sendPosition(this))}),a.addEventListener("keyup",function(e){-1!=[37,38,39,40].indexOf(e.keyCode)&&o.sendPosition(this)}),a.addEventListener("keydown",function(e){-1!=[37,38,39,40].indexOf(e.keyCode)&&o.sendPosition(this)}),a.addEventListener("click",function(e){document.activeElement===this&&o.sendPosition(this)}),a.addEventListener("blur",function(e){var t=o.generateTypeName(this);CoCreate.crdt.setCursorNull(t)}),a.addEventListener("input",function(e){var t=this.selectionStart-1,n=t,i=o.getSelectionInfo(this),a="",r=!1;switch(e.inputType){case"deleteContentBackward":case"deleteContentForward":r=!0,n=++t+1;break;case"insertLineBreak":r=!0,a="\n",n++;break;case"insertText":r=!0,a=e.data||"\n";break;case"deleteByCut":r=!0}r&&(i.is_selected?(i.start,i.end,o.sendChangeData(this,"",i.start,i.end),0<a.length&&o.sendChangeData(this,a,t,n),o.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)):o.sendChangeData(this,a,t,n))}),a.addEventListener("blur",function(e){o.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}),a.addEventListener("click",function(e){o.setSelectionInfo(this,!1,this.selectionStart,this.selectionStart)}),a.addEventListener("paste",function(e){var t=e.clipboardData.getData("Text"),n=this.selectionStart,i=this.selectionEnd;n!=i&&(this.setSelectionRange(i,i),o.sendChangeData(this,"",n,i,!1)),o.sendChangeData(this,t,n,n,!1),e.preventDefault()}),a.addEventListener("cocreate-y-update",function(e){var t=this,e=e.detail;a.crudSetted=!0;var n=0,i=!0;e.forEach(function(e){e.retain&&(i=!0,n=e.retain),(e.insert||e.delete)&&(0==i&&(n=0),i=!1,e.insert?o.updateChangeData(t,e.insert,n,n):e.delete&&o.updateChangeData(t,"",n,n+e.delete))})})},setSelectionInfo:function(e,t,n,i){e.setAttribute("is_selected",t),e.setAttribute("selection_start",n),e.setAttribute("selection_end",i),this.sendPosition(e)},getSelectionInfo:function(e){return{is_selected:"true"===e.getAttribute("is_selected"),start:parseInt(e.getAttribute("selection_start")),end:parseInt(e.getAttribute("selection_end"))}},checkDocumentID:function(e){e=e.getAttribute("data-document_id");return!(!e||""===e)},sendChangeData:function(e,t,n,i){var a,r,o,s,c=!(4<arguments.length&&void 0!==arguments[4])||arguments[4];if(!this.checkDocumentID(e))return CoCreate.document_id.request({element:e,nameAttr:"name"}),void e.setAttribute("data-document_id","pending");"pending"!=e.getAttribute("data-document_id")&&(a=e.getAttribute("data-collection"),r=e.getAttribute("data-document_id"),o=e.getAttribute("name"),"false"!=e.getAttribute("data-save_value")&&(s=0<t.length?t.length:-1,CoCreate.cursors.recalculate_local_cursors(e,s),this.sendPosition(e),0<t.length?(c&&e.setRangeText("",n,n+t.length,"start"),CoCreate.crdt.insertText({collection:a,document_id:r,name:o,value:t,position:n})):(c&&e.setRangeText(" ".repeat(i-n),n,n,"end"),CoCreate.crdt.deleteText({collection:a,document_id:r,name:o,position:n,length:i-n})),document.activeElement===e&&(this.setSelectionInfo(e,!1,e.selectionStart,e.selectionStart),this.sendPosition(e))))},updateChangeData:function(e,t,n,i){var a=e.selectionStart,r=e.selectionEnd;e.setRangeText(t,n,i,"end"),n<=a&&(""==t?(r-=i-n,a=(a-=i-n)<n?n:a):(a+=t.length,r+=t.length)),""==t&&n<=r&&(r=i<=r?r-(i-n):n),e.selectionStart=a,e.selectionEnd=r;document.activeElement;CoCreate.cursors.refresh_mirror(e),CoCreate.floatingLabel&&CoCreate.floatingLabel.update(e,e.value)},generateTypeName:function(e){var t=e.getAttribute("data-collection"),n=e.getAttribute("data-document_id"),e=e.getAttribute("name");return CoCreate.crdt.generateID(config.organization_Id,t,n,e)},setText:function(t,e){var n=this,i=0,a=!0;e.forEach(function(e){e.retain&&(a=!0,i=e.retain),(e.insert||e.delete)&&(0==a&&(i=0),a=!1,e.insert?n.receiveChangeData(t,e.insert,i,i):e.delete&&n.receiveChangeData(t,"",i,i+e.delete))})},isAvaiableEl:function(e){for(var t=0;t<this.elements.length;t++)if(console.log(this.elements[t].isEqualNode(e),e),!0===this.elements[t].isEqualNode(e))return!0;return!1},sendPosition:function(e){var t=this.generateTypeName(e),n=e.selectionStart,e=e.selectionEnd;CoCreate.crdt.setPositionYJS(t,n,e)}};i.init(),CoCreate.observer.init({name:"CoCreateTextCreate",observe:["subtree","childList"],include:"[data-collection][data-document_id][name]",callback:function(e){console.log("cocreate-text init"),i.initElement(e.target)}}),CoCreate.observer.init({name:"CoCreateTextNameObserver",observe:["attributes"],attributes:["name"],callback:function(e){console.log("change cocreate-text name"),i.refreshElement(e)}}),t.default=i}],a.c=i,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(n,i,function(e){return t[e]}.bind(null,i));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0).default;function a(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,a),t.l=!0,t.exports}var n,i});